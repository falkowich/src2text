#!/usr/bin/env bash
# src2text - Concatenate source files into single text output
# Usage: src2text [python|go|rust|js|typescript|auto] [max_lines_per_file]

set -euo pipefail

# Parse arguments
LANG="${1:-auto}"
MAX_LINES="${2:-0}"

# Auto-detect language
if [[ "$LANG" == "auto" ]]; then
    if [[ -f "Cargo.toml" ]]; then 
        LANG="rust"
    elif [[ -f "go.mod" ]]; then 
        LANG="go"
    elif [[ -f "package.json" ]]; then
        if [[ -f "tsconfig.json" ]] || grep -q '"typescript"' package.json 2>/dev/null; then
            LANG="typescript"
        else
            LANG="js"
        fi
    elif [[ -f "pyproject.toml" ]] || [[ -f "setup.py" ]] || [[ -f "requirements.txt" ]]; then 
        LANG="python"
    else 
        LANG="python"
    fi
    echo "Auto-detected: $LANG" >&2
fi

# Build find command based on language
case "$LANG" in
    python)
        FIND_CMD='find . -type f -name "*.py"'
        EXCLUDE='-not -path */venv/* -not -path */__pycache__/* -not -path */migrations/* -not -path */.venv/* -not -path */site-packages/* -not -path */.pytest_cache/*'
        ;;
    go)
        FIND_CMD='find . -type f -name "*.go"'
        EXCLUDE='-not -path */vendor/* -not -path */testdata/*'
        ;;
    rust)
        FIND_CMD='find . -type f -name "*.rs"'
        EXCLUDE='-not -path */target/* -not -path */vendor/*'
        ;;
    js)
        FIND_CMD='find . -type f \( -name "*.js" -o -name "*.jsx" -o -name "*.svelte" \)'
        EXCLUDE='-not -path */node_modules/* -not -path */dist/* -not -path */build/* -not -path */.svelte-kit/* -not -path */.next/*'
        ;;
    typescript)
        FIND_CMD='find . -type f \( -name "*.ts" -o -name "*.tsx" \)'
        EXCLUDE='-not -path */node_modules/* -not -path */dist/* -not -path */build/* -not -path */.next/*'
        ;;
    *)
        echo "Error: Unknown language '$LANG'" >&2
        echo "" >&2
        echo "Usage: src2text [python|go|rust|js|typescript|auto] [max_lines]" >&2
        exit 1
        ;;
esac

# Common excludes
COMMON_EXCLUDE='-not -path */.git/* -not -path */.idea/* -not -path */.vscode/* -not -path */.DS_Store'

echo "Scanning $LANG files..." >&2
echo "" >&2

# Execute find
FILES=$(eval "$FIND_CMD $EXCLUDE $COMMON_EXCLUDE" 2>/dev/null | sort)

FILE_COUNT=$(echo "$FILES" | grep -c . || echo 0)

if [[ $FILE_COUNT -eq 0 ]]; then
    echo "Error: No $LANG files found" >&2
    echo "In directory: $(pwd)" >&2
    exit 1
fi

echo "Found $FILE_COUNT files" >&2

# Token estimation
TOTAL_CHARS=$(echo "$FILES" | xargs wc -c 2>/dev/null | tail -1 | awk '{print $1}' || echo 0)
TOKENS=$((TOTAL_CHARS / 4))
echo "Estimated ~${TOKENS} tokens" >&2

if [[ $TOKENS -gt 150000 ]]; then
    echo "Warning: Large codebase (>150k tokens)" >&2
fi

echo "" >&2
echo "=== OUTPUT START ===" >&2
echo "" >&2

# Generate output
if [[ $MAX_LINES -gt 0 ]]; then
    echo "$FILES" | xargs awk -v max="$MAX_LINES" '
        FNR==1 {
            print "\n===== " FILENAME " =====\n"
            lines=0
        } 
        {
            if(lines++ < max) {
                print
            } else if(lines == max + 1) {
                print "... (truncated after " max " lines)"
            }
        }'
else
    echo "$FILES" | xargs awk 'FNR==1 {print "\n===== " FILENAME " =====\n"} {print}'
fi

echo "" >&2
echo "=== OUTPUT END ===" >&2#!/usr/bin/env bash
# src2text - Concatenate source files into single text output
# Usage: src2text [python|go|rust|js|typescript|auto] [max_lines_per_file]

set -euo pipefail

# Parse arguments
LANG="${1:-auto}"
MAX_LINES="${2:-0}"

# Auto-detect language
if [[ "$LANG" == "auto" ]]; then
    if [[ -f "Cargo.toml" ]]; then 
        LANG="rust"
    elif [[ -f "go.mod" ]]; then 
        LANG="go"
    elif [[ -f "package.json" ]]; then
        if [[ -f "tsconfig.json" ]] || grep -q '"typescript"' package.json 2>/dev/null; then
            LANG="typescript"
        else
            LANG="js"
        fi
    elif [[ -f "pyproject.toml" ]] || [[ -f "setup.py" ]] || [[ -f "requirements.txt" ]]; then 
        LANG="python"
    else 
        LANG="python"
    fi
    echo "Auto-detected: $LANG" >&2
fi

# Build find command based on language
case "$LANG" in
    python)
        FIND_CMD='find . -type f -name "*.py"'
        EXCLUDE='-not -path */venv/* -not -path */__pycache__/* -not -path */migrations/* -not -path */.venv/* -not -path */site-packages/* -not -path */.pytest_cache/*'
        ;;
    go)
        FIND_CMD='find . -type f -name "*.go"'
        EXCLUDE='-not -path */vendor/* -not -path */testdata/*'
        ;;
    rust)
        FIND_CMD='find . -type f -name "*.rs"'
        EXCLUDE='-not -path */target/* -not -path */vendor/*'
        ;;
    js)
        FIND_CMD='find . -type f \( -name "*.js" -o -name "*.jsx" -o -name "*.svelte" \)'
        EXCLUDE='-not -path */node_modules/* -not -path */dist/* -not -path */build/* -not -path */.svelte-kit/* -not -path */.next/*'
        ;;
    typescript)
        FIND_CMD='find . -type f \( -name "*.ts" -o -name "*.tsx" \)'
        EXCLUDE='-not -path */node_modules/* -not -path */dist/* -not -path */build/* -not -path */.next/*'
        ;;
    *)
        echo "Error: Unknown language '$LANG'" >&2
        echo "" >&2
        echo "Usage: src2text [python|go|rust|js|typescript|auto] [max_lines]" >&2
        exit 1
        ;;
esac

# Common excludes
COMMON_EXCLUDE='-not -path */.git/* -not -path */.idea/* -not -path */.vscode/* -not -path */.DS_Store'

echo "Scanning $LANG files..." >&2
echo "" >&2

# Execute find
FILES=$(eval "$FIND_CMD $EXCLUDE $COMMON_EXCLUDE" 2>/dev/null | sort)

FILE_COUNT=$(echo "$FILES" | grep -c . || echo 0)

if [[ $FILE_COUNT -eq 0 ]]; then
    echo "Error: No $LANG files found" >&2
    echo "In directory: $(pwd)" >&2
    exit 1
fi

echo "Found $FILE_COUNT files" >&2

# Token estimation
TOTAL_CHARS=$(echo "$FILES" | xargs wc -c 2>/dev/null | tail -1 | awk '{print $1}' || echo 0)
TOKENS=$((TOTAL_CHARS / 4))
echo "Estimated ~${TOKENS} tokens" >&2

if [[ $TOKENS -gt 150000 ]]; then
    echo "Warning: Large codebase (>150k tokens)" >&2
fi

echo "" >&2
echo "=== OUTPUT START ===" >&2
echo "" >&2

# Generate output
if [[ $MAX_LINES -gt 0 ]]; then
    echo "$FILES" | xargs awk -v max="$MAX_LINES" '
        FNR==1 {
            print "\n===== " FILENAME " =====\n"
            lines=0
        } 
        {
            if(lines++ < max) {
                print
            } else if(lines == max + 1) {
                print "... (truncated after " max " lines)"
            }
        }'
else
    echo "$FILES" | xargs awk 'FNR==1 {print "\n===== " FILENAME " =====\n"} {print}'
fi

echo "" >&2
echo "=== OUTPUT END ===" >&2
